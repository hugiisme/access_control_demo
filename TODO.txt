
TODO:
    Required:
        Trang Home (test hasPermission)
        Bảng actions: CRUD
        Bảng org_types: CRUD
        Bảng organizations: CRUD
        Bảng user (của organization đang xem): CRUD + gán vào tổ chức 
        Bảng system role (của organization đang xem): CRUD 
        Bảng permissions (của organization đang xem): CRUD + gán vào system role
        Bảng resources (của organization đang xem)
        Bảng org_join_request (đối với clb đội nhóm)

    Xem xét lại bảng quan hệ tài nguyên đa hình (Quan trọng vì là check quyền bước 3)
    Hàm buildSnapshot: Đối với create không cần mapping resouce_id cụ thể, chỉ cần 1 dòng cho resource_type đó (vì create thì làm gì đã có id cụ thể mà nó là quyền được làm gì với toàn bộ 1 loại tài nguyên)
    Sửa deactivate các nút chưa có quyền (hiện tại ko có quyền vẫn click được)
    Trong hàm buildSnapshot: hiện tại khi check system role => permissions => action + resource_type => đang có quyền hành động với tất cả resource thuộc resource type đó
        => Sửa lại thêm scope: có quyền hành động với tất cả resource thuộc resouce_type đó NHƯNG nằm trong scope cụ thể được phép của bản thân
    Chưa làm deactivate quyền (hiện tại là có trong csdl hay ko chứ ko phải deactivate)
    User 2 tự nhiên delete được
    Trang quyền đang sai (đang hiển thị các quyền người dùng này có, trong khi bình thường ko được phép như v, hoặc là xem hết hoặc là ko xem j cả, và chỉ gắn cho người cao nhất)

    SET AUTO tạo resource khi tạo data
    Fix lỗi tạo mới không hiển thị ngay (do chưa tạo resource đi kèm và update verion để ko phải đăng nhập lại)
    Có nên cho chọn cấp độ tổ chức ko
    Thêm bộ lọc cho các bảng
    vì là on delete cascade nên khi xóa parent org (hoặc bất kì cái gì có parent) thì child org (hoặc mấy cái child tương ứng) cũng sẽ bị xóa trong bảng thực tế, nhưng bảng resource thì lại vẫn giữ tài nguyên đó
    Check lại phần create user
    Cần chỉnh nút delete, đang có select name, nếu là liên kết (ví dụ user_orgs) thì không có name
    Gán quyền cho system_role đang lỗi, chưa hoạt động nên gắn tạm code khác vào => thiếu system_role -> permission và user -> system_role
FIX: 
    Sửa lại các trang quan hệ = danh sách checkboxes
Vấn đề:
    Tạo user mới thì nó đang không thuộc org nào => trong bảng resouces nó là null (có vde j ko?)
    Cần quyền view thì mới xem được => kể cả với permissions nó cũng cần quyền view của 1 permission cụ thể => cần quyền view của quyền view của quyền edit org thì mới xem được quyền xem quyền edit tổ chức và vân vân cứ thế loop mãi
    Để sau:
        Ủy quyền:
            Xác định ai là người được quyền ủy quyền đi 
            Xác định ai là người được quyền nhận ủy quyền 
            Có thể từ chối ủy quyền không 
            => tạo bảng cho ủy quyền (authorization)
        Điều kiện ủy quyền:
            Là ủy quyền có giới hạn (tạo thành viên mới nhưng chỉ được tạo 10 thành viên, chỉnh sửa hoạt động nhưng chỉ là hoạt động trong tổ chức con cụ thể nào đó)
            => Liệt kê list điều kiện => Tạo bảng điều kiện + điều kiện ủy quyền
        Cách để so sánh attributes với attributes
            => Chốt danh sách attributes => tạo bảng attributes

Note: 
    Đoàn trường tạo tài khoản => gắn vào khoa, ko qua ủy quyền
    Câu lạc bộ/Đội/Nhóm: Trưởng đơn vị duyệt 
        Vì cần duyệt thành viên => giữ lại user_orgs  
    Mọi người dùng đều nằm trong tổ chức cấp thấp nhất: cấp 3 (ALERT: chưa tạo ra đến đó thì sao => chưa cho tạo tài khoản khi chưa có tổ chức cấp 3)
    User là quan trọng nhất nên tạo user rồi mới tạo tổ chức và gán
        Khi tạo người dùng mới => người dùng chưa nằm trong tổ chức nào => gán vào tổ chức: chưa có role (hoặc có role default đã bị deactive tất cả quyền) => Cấp trên chọn cho tổ chức con 1 leader => gán role cho leader => leader tạo thêm tổ chức con, nhóm vai trò, vai trò rồi gán cho user bình thường
    Vai trò trong tổ chức là riêng lẻ: với mỗi tổ chức (dù là tổ chức con) cũng hiển thị vai trò riêng, không hiển thị vai trò ở tổ chức cha trong tổ chức con (Nói chung là chỉ hiển thị role trong chính tổ chức đang xem)
    Tạo resource khi tạo bất kì data mới trong bảng nào ko phải bảng liên kết
    Chỉ có người to nhất trong 1 tổ chức (Creator) mới có thể xem chi tiết (các liên kết) tổ chức đó (ALERT: vậy còn chi tiết của các tài nguyên khác như hoạt động, minh chứng => cần confirm lại khi họp)
    Vấn đề check tổ chức con (vì ko có loại tài nguyên tổ chức con): check qua serialize (check file phân quyền phần mã hóa 1.0.0.0)
    Trong bảng resources, loại tài nguyên action thì thuộc tổ chức Trường (to nhất)
    Bảng resouce_types là cố định, ko cho ai nghịch
    Các bước khi tạo/update bất kì cái gì:
        Insert/update (check duplicate)
        Create resource 
        Update resource_type_version 
        Thiết lập quan hệ user_resource
    Các bảng cần có sẵn data ngay từ đầu, ko cho phép chỉnh sửa: (vì ko đc chỉnh sửa nên cũng ko cần add vào resources làm gì)
        actions
        action_relations
        resource_types
    
Luồng:
    Đăng nhập: Chọn tài khoản có sẵn => lưu user_id vào session + build snapshot (nếu đã có snapshot => xóa đi build lại)
    Build snapshot (NOTE: mới chỉ làm 2 bước đầu):
        Bước 1: Check quyền từ system role (query kế thừa action)
        Bước 2: Check quyền từ resource role (query kế thừa action)
        Bước 3: Check quyền từ quan hệ của resource (tổ chức cha - tổ chức con, hoạt động - minh chứng, folder - file trong folder,...)
        Bước 4: Check quyền từ policy (điều kiện cụ thể)
        
        => Mục đích: Flatten csdl, không cần phải query đa tầng qua các bảng quan hệ mà có 1 bảng lưu tất cả thông tin để truy vấn trực tiếp
        Bảng snapshot gồm: id, user_id, action_id, resouce_id, resource_type_id, org_id, resource_type_version
        => Xác định được "Ai" + "Được làm gì" + "Với cái gì" + "Trong tổ chức nào"
        (chống duplicate bằng php nma sẽ đổi sau)
        Đặc biệt: Create thì chỉ cần resource_type_id mà ko cần mapping

    Hàm check quyền hasPermission(user_id, action_id, resource_id, resource_type_name):
        Bước 1: check trong user_permission_snapshots có resource_type nào trùng với resource_type của resource cụ thể này không
                Nếu ko có thì return False
        Bước 2: check version của resouce_type này (lazy update)
                Quyền = Hành động + Loại tài nguyên 
                Nếu cấp trên thay đổi quyền của vai trò (thêm quyền mới/ngắt quyền ra khỏi role) => xác định được loại tài nguyên bị ảnh hưởng
                => Nếu bị ảnh hưởng => version của loại tài nguyên +1
                Nếu version của loại tài nguyên trong snapshot != version của loại tài nguyên trong bảng resource_type => rebuild snapshot 
        Bước 3: check trong bảng snapshot xem người dùng có thể thực hiện hành động này với tài nguyên này không và return True/False 
        Đặc biệt: Create ko gắn với resource_id nên buộc cần resource_type_name

    Hàm getAccessibleResources(user_id, action_name, resource_type_name):
        Giống hasPermission nhưng trả lại danh sách các resource được phép thực hiện hành động
        Đặc thù cho view vì cần nhiều nhất 
        Áp dụng scope nhưng chưa test

    Đăng xuất: xóa snapshot của user đó khỏi bảng snapshot, giải phóng bộ nhớ